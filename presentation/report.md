---
## Front matter
title: "Доклад"
subtitle: "Инициализация систем BSD"
author: "Борисенкова София Павловна"
## Generic options
lang: ru-RU
toc-title: "Содержание"
## Pdf output format
toc: true # Table of contents
toc-depth: 2
lof: true # List of figures
lot: true # List of tables
fontsize: 12pt
linestretch: 1.5
papersize: a4
documentclass: scrreprt
## I18n polyglossia
polyglossia-lang:
  name: russian
  options:
	- spelling=modern
	- babelshorthands=true
polyglossia-otherlangs:
  name: english
## I18n babel
babel-lang: russian
babel-otherlangs: english
## Fonts
mainfont: IBM Plex Serif
romanfont: IBM Plex Serif
sansfont: IBM Plex Sans
monofont: IBM Plex Mono
mathfont: STIX Two Math
mainfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
romanfontoptions: Ligatures=Common,Ligatures=TeX,Scale=0.94
sansfontoptions: Ligatures=Common,Ligatures=TeX,Scale=MatchLowercase,Scale=0.94
monofontoptions: Scale=MatchLowercase,Scale=0.94,FakeStretch=0.9
mathfontoptions:
## Pandoc-crossref LaTeX customization
figureTitle: "Рис."
tableTitle: "Таблица"
listingTitle: "Листинг"
lofTitle: "Список иллюстраций"
lotTitle: "Список таблиц"
lolTitle: "Листинги"
## Misc options
indent: true
header-includes:
  - \usepackage{indentfirst}
  - \usepackage{float} # keep figures where there are in the text
  - \floatplacement{figure}{H} # keep figures where there are in the text
---
# Доклад: Инициализация систем BSD
 
## Введение
 
Инициализация операционной системы — это критически важный процесс, который начинается после завершения работы загрузчика ядра. В мире UNIX-подобных систем этот процесс всегда имеет идентификатор PID 1 и является родителем всех последующих процессов.
 
В то время как в современных дистрибутивах Linux доминируют systemd и OpenRC, системы семейства BSD сохраняют свой уникальный, целостный и проверенный временем подход к загрузке. Его ключевыми характеристиками являются простота, прозрачность и последовательность выполнения.
 
Философское отличие BSD от Linux заключается в том, что BSD рассматривается как единая, целостная операционная система, разработанная одной командой. Это отличие напрямую отражается в архитектуре процесса инициализации, который является не сборником разрозненных скриптов, а частью самой ОС.
 
## Основные компоненты системы инициализации BSD
 
Процесс загрузки в BSD строится вокруг нескольких ключевых компонентов, которые взаимодействуют друг с другом по четкому алгоритму.
 
### /sbin/init
 
Это исполняемый файл, который ядро запускает самым первым среди пользовательских процессов. Его главные задачи:
 
- Определить уровень выполнения (runlevel), например, однопользовательский (single-user) или многопользовательский (multi-user)
- Выполнить главный загрузочный скрипт `/etc/rc` для перехода в многопользовательский режим
- Управлять изменениями уровней выполнения во время работы системы
 
### /etc/rc
 
Это главный сценарий (shell-скрипт), который управляет всей загрузкой системы в многопользовательском режиме. Его можно назвать дирижером процесса инициализации.
 
Он выполняет следующие действия:
 
- Источник основных конфигурационных переменных из файла `/etc/rc.conf` и дополнительных файлов вроде `/etc/rc.conf.local`
- Выполняет базовые действия, общие для всех систем: монтирует файловые системы (согласно `/etc/fstab`), настраивает системные параметры через `/etc/rc.sysctl`, очищает временные директории
- Запускает базовую конфигурацию сети (скрипт `/etc/rc.network`)
- Находит и запускает скрипты служб из директорий `/etc/rc.d/` и `/usr/local/etc/rc.d/`
 
### /etc/rc.conf
 
Это центральный конфигурационный файл, определяющий поведение системы при загрузке. Вместо того чтобы иметь разрозненные конфиги для каждой службы, BSD использует простой и элегантный подход: все параметры задаются в виде переменных в одном файле.
 
**Пример содержимого `/etc/rc.conf`:**
Сетевая базовая настройка
hostname="freebsd-server"
defaultrouter="192.168.1.1"
ifconfig_em0="inet 192.168.1.10 netmask 255.255.255.0"
 
Какие службы запускать
sshd_enable="YES"
sendmail_enable="NO" # Часто отключают в пользу более современных MTA
nginx_enable="YES"
mysql_enable="YES"
 
Дополнительные параметры
clear_tmp_enable="YES"
syslogd_flags="-ss" # Не слушать сетевые подключения для безопасности
 
text
 
Такая централизация упрощает администрирование: чтобы понять, как настроена система, достаточно изучить один файл.
 
### Директории rc.d
 
Скрипты для управления отдельными службами (демонами) хранятся в строго определенных местах:
 
- `/etc/rc.d/` — для служб, входящих в базовую систему (например, `sshd`, `cron`, `sendmail`)
- `/usr/local/etc/rc.d/` — для служб, установленных из пакетов или портов (например, `nginx`, `postgresql`)
 
Каждый скрипт стандартизирован и понимает набор основных команд:
 
- `start` — запустить службу
- `stop` — остановить службу
- `restart` — перезапустить службу
- `status` — показать статус службы
 
Эти скрипты не запускаются сами по себе. Их главная задача — реагировать на команды от главного скрипта `/etc/rc` или системного администратора.
 
## Детальный разбор этапов загрузки (на примере FreeBSD)
 
### 1. Загрузка ядра
 
Загрузчик (например, `loader` в FreeBSD) загружает ядро и передает ему управление. Ядро инициализирует аппаратное обеспечение, обнаруживает устройства и подготавливает среду для запуска первого процесса.
 
### 2. Запуск /sbin/init
 
Ядро запускает `/sbin/init`, которому присваивается PID 1.
 
### 3. Однопользовательский режим (runlevel 's')
 
Сначала `init` пытается перевести систему в однопользовательский режим. Это режим восстановления, в котором:
 
- Не монтируются большинство файловых систем (только корневая — `/`, обычно в режиме "только для чтения")
- Не запускаются сетевые службы
- Пользователю `root` предоставляется интерпретатор командной строки (`/bin/sh`) без запроса пароля
- На этом этапе можно выполнить проверку файловых систем (`fsck`), исправить критические ошибки в конфигурации и т.д.
 
### 4. Переход в многопользовательский режим (runlevel 'multi-user')
 
Если администратор не прервет загрузку в однопользовательском режиме, система автоматически продолжит работу. Процесс `init` запускает главный скрипт `/etc/rc`, который выполняет следующую последовательность:
 
**Настройка базового окружения**
 
Чтение `/etc/rc.conf`, установка переменных окружения, имени хоста.
 
**Работа с файловыми системами**
 
Проверка (`fsck`) и монтирование всех файловых систем, указанных в `/etc/fstab`, в режиме чтения и записи.
 
**Очистка и настройка**
 
Очистка временных директорий (`/tmp`), настройка параметров ядра через `sysctl` (файл `/etc/rc.sysctl`).
 
**Базовая настройка сети**
 
Настройка сетевых интерфейсов, маршрутов по умолчанию (скрипт `/etc/rc.network`).
 
**Запуск системных служб**
 
Это ключевой этап. Скрипт `/etc/rc` обходит директории `/etc/rc.d/` и `/usr/local/etc/rc.d/` в алфавитном порядке. Для каждого найденного скрипта он проверяет, определена ли в `rc.conf` переменная `*_enable="YES"` (где `*` — имя службы). Если условие выполняется, скрипт запускается с аргументом `start`.
 
**Запуск getty/login**
 
В завершение запускаются виртуальные консоли (`/etc/ttys`) и, если настроено, графический менеджер входа (например, XDM).
 
## Управление службами на работающей системе
 
Администратор может вручную управлять службами, используя те же самые `rc.d`-скрипты.
 
### Ручной запуск и остановка
Запустить веб-сервер nginx
sudo /usr/local/etc/rc.d/nginx start
 
Остановить службу SSH
sudo /etc/rc.d/sshd stop
 
Перезапустить службу после изменения конфигурации
sudo /etc/rc.d/sshd restart
 
text
 
### Проверка статуса
Убедиться, что служба работает
sudo /etc/rc.d/sshd status
sshd is running as pid 1234.
 
text
 
### Включение автозапуска при загрузке
 
Для этого не требуется запускать специальные команды. Достаточно добавить соответствующую переменную в файл `/etc/rc.conf`.
Редактируем конфиг
echo 'postgresql_enable="YES"' >> /etc/rc.conf
 
После перезагрузки PostgreSQL запустится автоматически.
text
 
## Сравнение FreeBSD и OpenBSD
 
Хотя философия едина, есть и различия в реализации.
 
### FreeBSD
 
Представляет собой наиболее гибкую и богатую возможностями систему. Её инициализация — это классический пример описанного выше подхода. Администратор может напрямую редактировать `/etc/rc.conf`, а сама система предоставляет множество параметров для тонкой настройки.
 
### OpenBSD
 
Делает еще больший акцент на безопасности и минимализме. Системные файлы в `/etc` трогать не рекомендуется. Все пользовательские настройки вносятся в файл `/etc/rc.conf.local`. Скрипты в `/etc/rc.d/` более простые и строгие. По умолчанию многие потенциально опасные службы отключены, что соответствует принципу "безопасность по умолчанию".
 
## Заключение
 
Система инициализации BSD является образцом инженерной элегантности и практичности. Её простота не является недостатком; напротив, это следствие продуманного дизайна.
 
Централизованная конфигурация через `/etc/rc.conf` делает систему предсказуемой и легко управляемой. Последовательный, непараллельный запуск служб упрощает поиск и устранение неисправностей — если система "зависла" при загрузке, всегда легко определить, на каком именно скрипте это произошло.
 
В эпоху, когда сложность таких систем, как systemd, часто становится предметом споров, подход BSD предлагает альтернативу, проверенную десятилетиями стабильной эксплуатации на критически важных серверах по всему миру. Понимание этого механизма — ключ к эффективному администрированию любой системы из семейства BSD.
